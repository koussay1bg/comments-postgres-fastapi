import asyncpg
from fastapi import Depends, FastAPI

app = FastAPI()

DATABASE_URL = "postgresql://postgres:0000@db:5432/comments"

# Connect to the database
async def connect_to_db():
    try:
        conn = await asyncpg.connect(DATABASE_URL)
        return conn
    except Exception as e:
        print(f"Unable to connect to database: {e}")
        return None

# Disconnect from the database
async def close_db_connection(conn):
    try:
        await conn.close()
    except Exception as e:
        print(f"Unable to close database connection: {e}")



# Save new comment to the database
@app.post("/comments")
async def save_comment(comment: str, sentiment: str, conn = Depends(connect_to_db)):
    try:
        await conn.execute("INSERT INTO comments (comment, sentiment) VALUES ($1, $2)", comment, sentiment)
        return {"success": True, "message": "Comment saved successfully."}
    except Exception as e:
        print(f"Unable to save comment: {e}")
        return {"success": False, "message": "Error saving comment."}

# Search for comments containing keywords
@app.get("/comments/search")
async def search_comments(query: str, conn = Depends(connect_to_db)):
    try:
        search_query = f"%{query}%"
        results = await conn.fetch("SELECT * FROM comments WHERE comment LIKE $1", search_query)
        return {"success": True, "data": results}
    except Exception as e:
        print(f"Unable to search for comments: {e}")
        return {"success": False, "message": "Error searching for comments."}

# Update sentiment for existing comment
@app.put("/comments/{comment_id}")
async def update_sentiment(comment_id: int, sentiment: str, conn = Depends(connect_to_db)):
    try:
        await conn.execute("UPDATE comments SET sentiment = $1 WHERE id = $2", sentiment, comment_id)
        return {"success": True, "message": "Comment updated successfully."}
    except Exception as e:
        print(f"Unable to update comment: {e}")
        return {"success": False, "message": "Error updating comment."}

# Delete comment from database
@app.delete("/comments/{comment_id}")
async def delete_comment(comment_id: int, conn = Depends(connect_to_db)):
    try:
        await conn.execute("DELETE FROM comments WHERE id = $1", comment_id)
        return {"success": True, "message": "Comment deleted successfully."}
    except Exception as e:
        print(f"Unable to delete comment: {e}")
        return {"success": False, "message": "Error deleting comment."}

# Close database connection when application stops
@app.on_event("shutdown")
async def shutdown_event():
    await close_db_connection(asyncpg.connect)

# Create comments table on startup
@app.on_event("startup")
async def startup_event():
    conn = await connect_to_db()
    await close_db_connection(conn)